---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Trail Map" description="Interactive map of the CRE Trails system in Chesapeake Ranch Estates. View trail routes, distances, and points of interest.">
  <section style="padding-top: var(--spacing-xl);">
    <div class="container">
      <h1>Trail Map</h1>
      <p class="text-center" style="font-size: 1.125rem; color: var(--color-text-light); max-width: 800px; margin: var(--spacing-md) auto var(--spacing-xl);">
        Explore our trail system with this interactive map. Click on trails for more information.
      </p>

      <div id="map" style="height: 450px; border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-bottom: var(--spacing-lg);"></div>

      <div class="grid grid-2" style="margin-top: var(--spacing-xl);">
        <div class="card">
          <h3>üì• Download Map</h3>
          <p>Take the trail map with you for offline use:</p>
          <div style="margin-top: var(--spacing-md); display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
            <button id="download-pdf" class="btn btn-primary">Download PDF</button>
            <button id="download-gpx" class="btn btn-secondary">Download GPX</button>
          </div>
          <p style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: var(--color-text-light);">
            GPX files can be loaded into GPS devices and hiking apps.
          </p>
        </div>

        <div class="card">
          <h3>üß≠ Trail Legend</h3>
          <div style="margin-top: var(--spacing-md);">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <div style="width: 30px; height: 4px; background-color: #e74c3c;"></div>
              <span>Red Trail</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <div style="width: 30px; height: 4px; background-color: #3498db;"></div>
              <span>Blue Trail</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <div style="width: 30px; height: 4px; background-color: #f39c12;"></div>
              <span>Orange Trail</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <div style="width: 30px; height: 4px; background-color: #2ecc71;"></div>
              <span>Green Trail</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <div style="width: 30px; height: 4px; background-color: #9b59b6;"></div>
              <span>Purple Trail</span>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top: var(--spacing-xl);">
        <h2>Trail Information</h2>
        
        <div class="grid grid-3" style="margin-top: var(--spacing-lg);">
          <div class="card">
            <h3>üö∂ Difficulty</h3>
            <p>Most trails are easy to moderate, suitable for all fitness levels. Some sections may have roots, rocks, or slight elevation changes.</p>
          </div>

          <div class="card">
            <h3>üìè Distance</h3>
            <p>Individual trail loops range from 0.5 to 2 miles. Multiple loops can be combined for longer hikes.</p>
          </div>

          <div class="card">
            <h3>üïê Time</h3>
            <p>Plan 20-40 minutes per mile depending on pace. Allow extra time for nature observation and rest stops.</p>
          </div>
        </div>
      </div>

      <div class="info-box warning" style="margin-top: var(--spacing-xl);">
        <h3>‚ö†Ô∏è Important Reminders</h3>
        <ul style="margin-left: var(--spacing-lg); margin-top: var(--spacing-sm);">
          <li>Trails are open <strong>dawn to dusk</strong> only</li>
          <li>Stay on marked trails</li>
          <li>Carry water and a phone</li>
          <li>Check weather before heading out</li>
          <li>Tell someone where you're going</li>
        </ul>
        <p style="margin-top: var(--spacing-sm);">
          <a href={`${import.meta.env.BASE_URL}/rules`} style="color: inherit; text-decoration: underline;">Review all trail rules and safety guidelines ‚Üí</a>
        </p>
      </div>
    </div>
  </section>
</Layout>

<script>
  import L from 'leaflet';

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', async () => {
    // Chesapeake Ranch Estates approximate coordinates
    const centerLat = 38.4121;
    const centerLng = -76.4575;

    // Initialize the map
    const map = L.map('map').setView([centerLat, centerLng], 15);

    // Define basemap layers
    const baseMaps = {
      "Street Map (OpenStreetMap)": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }),
      "USGS Topo": L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>',
        maxZoom: 16
      }),
      "USGS Imagery + Topo": L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>',
        maxZoom: 16
      }),
      "CyclOSM": L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
        attribution: '<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 20
      }),
      "Esri World Hillshade": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri World Hillshade &copy; Esri',
        maxZoom: 16
      }),
      "Esri World Topo Map": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri World Topo &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community',
        maxZoom: 16
      }),
      "Satellite Imagery (Esri)": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
        maxZoom: 19
      })
    };

    // Add default layer (Street Map)
    baseMaps["Street Map (OpenStreetMap)"].addTo(map);

    // Create layer groups for overlays
    const trailLayers = {};

    // Function to parse GPX and add to map
    async function loadGPXFile(url, layerName) {
      try {
        const response = await fetch(url);
        const gpxText = await response.text();
        const parser = new DOMParser();
        const gpxDoc = parser.parseFromString(gpxText, 'text/xml');

        // Create a layer group for this GPX file
        const gpxLayerGroup = L.layerGroup();

        // Parse tracks
        const tracks = gpxDoc.querySelectorAll('trk');
        const allCoordinates = [];

        tracks.forEach((track, index) => {
          const trackName = track.querySelector('name')?.textContent || `Track ${index + 1}`;
          const trackPoints = track.querySelectorAll('trkpt');
          const coordinates = [];

          trackPoints.forEach(pt => {
            const lat = parseFloat(pt.getAttribute('lat'));
            const lon = parseFloat(pt.getAttribute('lon'));
            if (!isNaN(lat) && !isNaN(lon)) {
              coordinates.push([lat, lon]);
              allCoordinates.push([lat, lon]);
            }
          });

          if (coordinates.length > 0) {
            // Create polyline for the track
            const polyline = L.polyline(coordinates, {
              color: '#e74c3c',
              weight: 4,
              opacity: 0.8
            });

            // Add to the layer group instead of directly to map
            polyline.addTo(gpxLayerGroup);

            // Calculate distance
            let distance = 0;
            for (let i = 1; i < coordinates.length; i++) {
              distance += map.distance(coordinates[i - 1], coordinates[i]);
            }
            const distanceMiles = (distance * 0.000621371).toFixed(2);

            polyline.bindPopup(`
              <div style="font-family: var(--font-body);">
                <h3 style="color: #e74c3c; margin-bottom: 8px;">${trackName}</h3>
                <p style="margin: 0;"><strong>Distance:</strong> ${distanceMiles} miles</p>
              </div>
            `);
          }
        });

        // Add the layer group to map and store it
        gpxLayerGroup.addTo(map);
        // Add visual indicator to layer name
        const layerNameWithIcon = `<span style="display: inline-flex; align-items: center; gap: 8px;"><span style="display: inline-block; width: 20px; height: 3px; background-color: #e74c3c; border-radius: 2px;"></span>${layerName}</span>`;
        trailLayers[layerNameWithIcon] = gpxLayerGroup;

        // Fit map to show all tracks
        if (allCoordinates.length > 0) {
          const bounds = L.latLngBounds(allCoordinates);
          map.fitBounds(bounds, { padding: [50, 50] });
        }

        return allCoordinates;
      } catch (error) {
        console.error('Error loading GPX file:', error);
        alert('Error loading trail data. Please try again later.');
        return [];
      }
    }

    // Load the GPX file
    const baseUrl = import.meta.env.BASE_URL || '';
    const gpxUrl = `${baseUrl}/gpx/20260107-152630-Cre-trails.gpx`;
    const trailCoordinates = await loadGPXFile(gpxUrl, 'CRE Trails');

    // Add layer control with basemaps and trail overlays
    L.control.layers(baseMaps, trailLayers).addTo(map);

    // Add a marker for the trailhead/clubhouse if we have coordinates
    if (trailCoordinates.length > 0) {
      // Use the first coordinate as approximate trailhead location
      const trailheadMarker = L.marker(trailCoordinates[0]).addTo(map);
      trailheadMarker.bindPopup(`
        <div style="font-family: var(--font-body);">
          <h3 style="margin-bottom: 8px;">Trailhead</h3>
          <p style="margin: 0;">424 Clubhouse Drive<br>Lusby, MD 20657</p>
        </div>
      `);
    }

    // Download PDF functionality
    document.getElementById('download-pdf')?.addEventListener('click', () => {
      alert('PDF download functionality would be implemented here. For now, you can take a screenshot of the map or contact us for a printed map.');
    });

    // Download GPX functionality
    document.getElementById('download-gpx')?.addEventListener('click', () => {
      // Download the actual GPX file
      const baseUrl = import.meta.env.BASE_URL || '';
      const gpxUrl = `${baseUrl}/gpx/20260107-152630-Cre-trails.gpx`;
      const a = document.createElement('a');
      a.href = gpxUrl;
      a.download = 'cre-trails.gpx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  });
</script>

<style>
  /* Fix Leaflet marker icons */
  :global(.leaflet-default-icon-path) {
    background-image: url('https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png');
  }
</style>